# earnings_swing.py 設計書

## 1. 概要

`earnings_swing.py`は、決算発表後に特定の条件を満たす株式銘柄を自動的にスクリーニングし、それらに対してスイングトレード戦略を実行するプログラムです。主にFinvizスクリーナーやGoogleスプレッドシートからトレード対象銘柄を取得し、Alpaca Trading APIを使用して取引を実行します。

## 2. 主要機能

### 2.1 銘柄選定機能
- **Finvizスクリーナーからの銘柄取得** (`get_tickers_from_screener`)
  - 決算発表後の銘柄を特定の条件でフィルタリング
  - スコアリングシステムによる銘柄ランキング
- **GoogleスプレッドシートからのトレードコマンドICE** (`get_tickers_from_sheet`)
  - 手動で入力された銘柄情報の取得
  - 使用後のコマンドクリア機能

### 2.2 トレード実行機能
- **マーケットオープン時間の管理** (`sleep_until_open`)
  - 次の取引日のマーケットオープンまで待機
- **スイングトレード戦略の実行** (`swing_earnings_stocks`)
  - リスク管理基準のチェック
  - 戦略配分に基づくポジションサイズ計算
  - 外部Pythonスクリプト（`orb.py`または`orb_paper.py`）の起動による注文実行

## 3. データフロー

1. リスク管理基準の確認（`risk_management.check_pnl_criteria`）
2. 戦略配分の計算（`strategy_allocation.get_target_value`）
3. マーケットオープン前の待機
4. トレード対象銘柄の取得（Finvizスクリーナー＋Googleスプレッドシート）
5. 重複銘柄の削除と高配当ポートフォリオ銘柄の除外
6. 各銘柄に対するスイングトレード戦略の実行（サブプロセス）

## 4. 外部依存関係

### 4.1 APIサービス
- **Alpaca Trading API**
  - 株式取引注文の実行
  - マーケットカレンダー情報の取得
- **Finviz Elite API**
  - スクリーニング条件に合致する銘柄の検索

### 4.2 外部システム
- **Google Sheets API**
  - 手動でのトレード指示の読み取り

### 4.3 内部モジュール
- **risk_management**: トレード実行の判断基準
- **strategy_allocation**: 戦略ごとの資金配分
- **dividend_portfolio_management**: 高配当銘柄リスト管理
- **orb.py/orb_paper.py**: 実際のトレード実行ロジック

## 5. スクリーニング条件（Finviz）

現在の条件：
- 市場時価総額: $1B-$30B
- 決算日: 昨日の引け後または本日の寄り付き前
- EPSサプライズ: 予想を5%以上上回る
- 収益性: 黒字企業のみ
- 地域: アメリカ
- 平均出来高: 200K株以上
- インサイダー保有: 50%以下
- 株価: $10以上
- 株価変化: 当日上昇
- 月間パフォーマンス: 過去4週間で上昇
- ボラティリティ: 1週間で1%以上

## 6. スコアリングシステム

銘柄選定のスコアリング基準：
- **EPS Surprise**
  - 5%以上: +1点
  - 8%以上: +1点
  - 10%以上: +2点
  - 30%以上: +2点
- **Revenue Surprise**
  - 2%以上: +1点
  - 8%以上: +1点
  - 15%以上: +1点
- **株価変化**
  - 1%以上: +1点
  - 8%以上: +1点
- **相対出来高**
  - 1.0以上: +2点
  - 1.5以上: +2点
  - 2.0以上: +2点

## 7. 実行フロー

1. プログラム起動
2. PnL基準のチェック（基準未達の場合は終了）
3. 戦略配分に基づくポジションサイズの計算
4. マーケットオープン2分前まで待機
5. Finvizスクリーナーから銘柄取得
6. Googleスプレッドシートから銘柄取得
7. 重複銘柄の削除
8. 各銘柄についてスイングトレード実行（高配当銘柄は除外）
9. 全トレードの完了を待機して終了

## 8. 設定パラメータ

- **NUMBER_OF_STOCKS**: スクリーナーから選択する最大銘柄数（現在: 5）
- **ALPACA_ACCOUNT**: 使用するアカウントタイプ（'live'/'paper'）
- **FINVIZ_MAX_RETRIES**: Finviz API呼び出しの最大リトライ回数
- **FINVIZ_RETRY_WAIT**: リトライ時の初期待機時間（秒）
